generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  name             String?
  aliasName        String?
  emailVerified    DateTime?
  createdAt        DateTime          @default(now())
  role             String            @default("USER")
  totalPurchases   Int               @default(0)
  totalGifts       Int               @default(0)
  phoneNumber      String?
  addressLine1     String?
  addressLine2     String?
  city             String?
  state            String?
  postalCode       String?
  country          String?
  profileUpdatedAt DateTime?
  drawEntries      LuckyDrawEntry[]
  drawWins         LuckyDrawWinner[]
  orders           Order[]
  purchases        Purchase[]
  redemptions      Redemption[]
}

model EmailOtp {
  id        String   @id @default(cuid())
  email     String
  otpHash   String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

model Purchase {
  id                 String            @id @default(cuid())
  userId             String
  codeHash           String            @unique
  codeLast4          String
  batch              String?
  productId          String?
  verifierName       String?
  rawPayload         String?
  verifiedAt         DateTime          @default(now())
  verificationCodeId String?           @unique
  user               User              @relation(fields: [userId], references: [id])
  verificationCode   VerificationCode? @relation(fields: [verificationCodeId], references: [id])

  @@index([userId])
  @@index([codeHash])
}

model VerificationCode {
  id                String    @id @default(cuid())
  codeHash          String    @unique
  securityHash      String
  codeLast4         String
  securityLast4     String
  batch             String?
  productId         String?
  codeValue         String?
  securityCodeValue String?
  createdAt         DateTime  @default(now())
  purchase          Purchase?

  @@index([batch])
  @@index([createdAt])
}

model Gift {
  id          String       @id @default(cuid())
  name        String
  description String?
  imageUrl    String?
  isActive    Boolean      @default(true)
  inventory   Int          @default(0)
  sortOrder   Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  redemptions Redemption[]

  @@index([isActive])
  @@index([sortOrder])
}

model Redemption {
  id             String    @id @default(cuid())
  userId         String
  giftId         String?
  status         String    @default("PENDING")
  giftDesc       String?
  giftImageUrl   String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  approvedBy     String?
  courierName    String?
  trackingNumber String?
  shippedAt      DateTime?
  gift           Gift?     @relation(fields: [giftId], references: [id])
  user           User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([giftId])
}

model FeatureFlag {
  key       String   @id
  enabled   Boolean  @default(false)
  meta      String?
  updatedAt DateTime @updatedAt
}

model Product {
  id               String         @id @default(cuid())
  slug             String         @unique
  name             String
  shortDescription String?
  longDescription  String?
  heroImageUrl     String?
  priceCents       Int
  currency         String         @default("MYR")
  inventory        Int            @default(0)
  isActive         Boolean        @default(true)
  isFeatured       Boolean        @default(false)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  orderItems       OrderItem[]
  gallery          ProductImage[]
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  imageUrl  String
  altText   String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])

  @@index([productId])
}

model Order {
  id                     String      @id @default(cuid())
  userId                 String
  status                 String      @default("PENDING_PAYMENT")
  totalCents             Int
  currency               String      @default("MYR")
  message                String?
  courierId              String?
  courierName            String?
  trackingNumber         String?
  shippingFeeCents       Int         @default(0)
  paymentNote            String?
  promoCodeId            String?
  promoCodeDiscountCents Int         @default(0)
  promotionId            String?
  promotionDiscountCents Int         @default(0)
  completedAt            DateTime?
  createdAt              DateTime    @default(now())
  updatedAt              DateTime    @updatedAt
  courier                Courier?    @relation(fields: [courierId], references: [id])
  promoCode              PromoCode?  @relation(fields: [promoCodeId], references: [id])
  promotion              Promotion?  @relation(fields: [promotionId], references: [id])
  user                   User        @relation(fields: [userId], references: [id])
  items                  OrderItem[]

  @@index([userId])
  @@index([status])
  @@index([promoCodeId])
  @@index([promotionId])
  @@index([courierId])
  @@index([completedAt])
}

model Courier {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  feeCents    Int      @default(0)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      Order[]

  @@index([isActive])
}

model OrderItem {
  id         String   @id @default(cuid())
  orderId    String
  productId  String
  quantity   Int      @default(1)
  priceCents Int
  createdAt  DateTime @default(now())
  order      Order    @relation(fields: [orderId], references: [id])
  product    Product  @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model Promotion {
  id                  String   @id @default(cuid())
  name                String
  description         String?
  startAt             DateTime
  endAt               DateTime
  timezone            String   @default("Asia/Kuala_Lumpur")
  isActive            Boolean  @default(true)
  discountType        String   @default("PERCENTAGE")
  discountValue       Int
  maxUsage            Int?
  completedUsageCount Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  orders              Order[]

  @@index([startAt])
  @@index([endAt])
}

model PromoCode {
  id                  String   @id @default(cuid())
  code                String   @unique
  description         String?
  discountType        String   @default("FIXED")
  discountValue       Int
  minOrderCents       Int      @default(0)
  startAt             DateTime
  endAt               DateTime
  timezone            String   @default("Asia/Kuala_Lumpur")
  usageCount          Int      @default(0)
  maxUsage            Int?
  completedUsageCount Int      @default(0)
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  orders              Order[]

  @@index([code])
  @@index([startAt])
  @@index([endAt])
}

model LuckyDraw {
  id          String            @id @default(cuid())
  title       String
  description String?
  status      String            @default("DRAFT")
  maxWinners  Int               @default(1)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  entries     LuckyDrawEntry[]
  winners     LuckyDrawWinner[]
}

model LuckyDrawEntry {
  id        String    @id @default(cuid())
  drawId    String
  userId    String
  createdAt DateTime  @default(now())
  tickets   Int       @default(1)
  draw      LuckyDraw @relation(fields: [drawId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([drawId, userId])
  @@index([drawId])
  @@index([userId])
}

model LuckyDrawWinner {
  id        String    @id @default(cuid())
  drawId    String
  userId    String
  createdAt DateTime  @default(now())
  draw      LuckyDraw @relation(fields: [drawId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@index([drawId])
  @@index([userId])
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String?
  action    String
  targetId  String?
  details   String?
  createdAt DateTime @default(now())

  @@index([actorId])
  @@index([action])
}

model SeoSettings {
  id             Int      @id @default(1)
  siteName       String   @default("Swiss Bright")
  baseUrl        String   @default("https://swissbright.com")
  defaultOgImage String   @default("/og/default.jpg")
  twitterHandle  String   @default("@swissbright")
  updatedAt      DateTime @updatedAt
}

model Content {
  id          String   @id @default(cuid())
  key         String
  type        String
  value       String
  language    String   @default("en")
  page        String?
  section     String?
  label       String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([key, language])
  @@index([page])
  @@index([section])
  @@index([key])
  @@index([language])
}

model ContactLink {
  id          String   @id @default(cuid())
  label       String
  url         String
  logoUrl     String?
  description String?
  accentColor String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Visit {
  id        String   @id @default(cuid())
  visitorId String
  page      String?
  referrer  String?
  userAgent String?
  ipAddress String?
  country   String?
  createdAt DateTime @default(now())

  @@index([visitorId])
  @@index([createdAt])
  @@index([page])
}
