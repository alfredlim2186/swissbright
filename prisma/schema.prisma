// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  aliasName      String?
  emailVerified  DateTime?
  createdAt      DateTime @default(now())
  role           String   @default("USER") // USER or ADMIN

  totalPurchases Int      @default(0)
  totalGifts     Int      @default(0)

  phoneNumber     String?
  addressLine1    String?
  addressLine2    String?
  city            String?
  state           String?
  postalCode      String?
  country         String?
  profileUpdatedAt DateTime?

  purchases      Purchase[]
  redemptions    Redemption[]
  drawEntries    LuckyDrawEntry[]
  drawWins       LuckyDrawWinner[]
  orders         Order[]
}

model EmailOtp {
  id         String   @id @default(cuid())
  email      String
  otpHash    String
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  @@index([email])
}

model Purchase {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  codeHash      String   @unique
  codeLast4     String
  batch         String?
  productId     String?
  verifierName  String?
  rawPayload    String?  // JSON as string for SQLite
  verifiedAt    DateTime @default(now())
  verificationCodeId String? @unique
  verificationCode   VerificationCode? @relation(fields: [verificationCodeId], references: [id])

  @@index([userId])
  @@index([codeHash])
}

model VerificationCode {
  id            String    @id @default(cuid())
  codeHash      String    @unique
  securityHash  String
  codeLast4     String
  securityLast4 String
  batch         String?
  productId     String?
  codeValue      String?
  securityCodeValue String?
  createdAt     DateTime  @default(now())

  purchase      Purchase?

  @@index([batch])
  @@index([createdAt])
}

model Gift {
  id          String   @id @default(cuid())
  name        String
  description String?
  imageUrl    String?
  isActive    Boolean  @default(true)
  inventory   Int      @default(0)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  redemptions Redemption[]

  @@index([isActive])
  @@index([sortOrder])
}

model Redemption {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  giftId     String?
  gift       Gift?    @relation(fields: [giftId], references: [id])
  status     String   @default("PENDING") // PENDING, APPROVED, SHIPPED, REJECTED
  giftDesc   String?  // Legacy field, kept for backward compatibility
  giftImageUrl String? // Legacy field, kept for backward compatibility
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  approvedBy String?
  courierName    String?
  trackingNumber String?
  shippedAt      DateTime?

  @@index([userId])
  @@index([status])
  @@index([giftId])
}

model FeatureFlag {
  key       String   @id
  enabled   Boolean  @default(false)
  meta      String?  // JSON as string for SQLite
  updatedAt DateTime @updatedAt
}

model Product {
  id             String   @id @default(cuid())
  slug           String   @unique
  name           String
  shortDescription String?
  longDescription  String?
  heroImageUrl   String?
  priceCents     Int
  currency       String   @default("MYR")
  inventory      Int      @default(0)
  isActive       Boolean  @default(true)
  isFeatured     Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  gallery        ProductImage[]
  orderItems     OrderItem[]
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  imageUrl  String
  altText   String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  @@index([productId])
}

model Order {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  status         String   @default("PENDING_PAYMENT")
  totalCents     Int
  currency       String   @default("MYR")
  message        String?
  courierId      String?
  courier        Courier? @relation(fields: [courierId], references: [id])
  courierName    String?
  trackingNumber String?
  shippingFeeCents Int    @default(0)
  paymentNote    String?
  promoCodeId    String?
  promoCode      PromoCode? @relation(fields: [promoCodeId], references: [id])
  promoCodeDiscountCents Int @default(0)
  promotionId    String?
  promotion      Promotion? @relation(fields: [promotionId], references: [id])
  promotionDiscountCents Int @default(0)
  completedAt    DateTime? // When order was marked as completed (for usage tracking)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  items          OrderItem[]

  @@index([userId])
  @@index([status])
  @@index([promoCodeId])
  @@index([promotionId])
  @@index([courierId])
  @@index([completedAt])
}

model Courier {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  feeCents    Int      @default(0)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      Order[]

  @@index([isActive])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int      @default(1)
  priceCents Int
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

model Promotion {
  id          String   @id @default(cuid())
  name        String
  description String?
  startAt     DateTime
  endAt       DateTime
  timezone    String   @default("Asia/Kuala_Lumpur")
  isActive    Boolean  @default(true)
  discountType String  @default("PERCENTAGE")
  discountValue Int
  maxUsage    Int?     // Maximum number of completed orders allowed (null = unlimited)
  completedUsageCount Int @default(0) // Count of completed orders using this promotion
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      Order[]

  @@index([startAt])
  @@index([endAt])
}

model PromoCode {
  id          String            @id @default(cuid())
  code        String            @unique
  description String?
  discountType String @default("FIXED")
  discountValue Int             // cents for FIXED, percent (0-100) for PERCENTAGE
  minOrderCents Int             @default(0)
  startAt     DateTime
  endAt       DateTime
  timezone    String            @default("Asia/Kuala_Lumpur")
  usageCount  Int               @default(0) // Total times used (including pending)
  maxUsage    Int?              // Maximum number of completed orders allowed (null = unlimited)
  completedUsageCount Int       @default(0) // Count of completed orders using this promo code
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  orders      Order[]

  @@index([code])
  @@index([startAt])
  @@index([endAt])
}
model LuckyDraw {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("DRAFT") // DRAFT, OPEN, CLOSED, DRAWN
  maxWinners  Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  entries     LuckyDrawEntry[]
  winners     LuckyDrawWinner[]
}

model LuckyDrawEntry {
  id        String    @id @default(cuid())
  drawId    String
  draw      LuckyDraw @relation(fields: [drawId], references: [id])
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  createdAt DateTime  @default(now())
  tickets   Int       @default(1)

  @@unique([drawId, userId])
  @@index([drawId])
  @@index([userId])
}

model LuckyDrawWinner {
  id        String    @id @default(cuid())
  drawId    String
  draw      LuckyDraw @relation(fields: [drawId], references: [id])
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  createdAt DateTime  @default(now())

  @@index([drawId])
  @@index([userId])
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String?
  action    String
  targetId  String?
  details   String?  // JSON as string for SQLite
  createdAt DateTime @default(now())

  @@index([actorId])
  @@index([action])
}

model SeoSettings {
  id              Int      @id @default(1)
  siteName        String   @default("SweetB")
  baseUrl         String   @default("https://sweetb.co")
  defaultOgImage  String   @default("/og/default.jpg")
  twitterHandle   String   @default("@sweetb")
  updatedAt       DateTime @updatedAt
}

model Content {
  id          String   @id @default(cuid())
  key         String   // e.g., "hero.headline", "product.description"
  type        String   // TEXT, IMAGE, ICON
  value       String   // The actual content
  language    String   @default("en") // en, ms, zh-CN
  page        String?  // Which page: "home", "about", "benefits", etc.
  section     String?  // Which section: "hero", "product", "safety", etc.
  label       String?  // Human-readable label for admin UI
  description String?  // Help text for admin
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([key, language])
  @@index([page])
  @@index([section])
  @@index([key])
  @@index([language])
}

model ContactLink {
  id          String   @id @default(cuid())
  label       String
  url         String
  logoUrl     String?
  description String?
  accentColor String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Visit {
  id        String   @id @default(cuid())
  visitorId String   // Unique identifier for the visitor (fingerprint)
  page      String?  // Page path
  referrer  String?  // Referrer URL
  userAgent String?  // User agent string
  ipAddress String?  // IP address (hashed for privacy)
  country   String?  // Country code (optional)
  createdAt DateTime @default(now())

  @@index([visitorId])
  @@index([createdAt])
  @@index([page])
}

